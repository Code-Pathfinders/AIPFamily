# 关系图显示问题排查指南

## 🔍 问题描述

创建了家族成员后，关系图区域显示空白，看不到节点。

## 🎯 问题原因

主要有以下几个可能的原因：

### 1. 独立节点无法显示（最常见）
如果创建的成员之间**没有设置父子关系**，G6的dagre布局可能无法正确计算节点位置，导致节点不显示。

**解决方案**：已修复代码，为独立节点添加默认位置。

### 2. 图形容器高度问题
如果容器高度为0，图形无法渲染。

### 3. 数据未正确加载
前端可能没有正确从后端获取成员数据。

## ✅ 已修复的问题

我已经对 `FamilyTree.vue` 组件进行了以下修复：

### 修复1：为独立节点添加默认位置

```typescript
// 修改前：只有保存的位置才设置坐标
if (member.positionX !== undefined && member.positionY !== undefined) {
  node.x = member.positionX
  node.y = member.positionY
}

// 修改后：为所有节点设置坐标
if (member.positionX !== undefined && member.positionY !== undefined) {
  node.x = member.positionX
  node.y = member.positionY
} else {
  // 为独立节点设置默认位置
  const generation = member.generation || 1
  const xOffset = index * 200
  node.x = 100 + xOffset
  node.y = 100 + (generation - 1) * 150
}
```

### 修复2：优化图形配置

```typescript
layout: {
  type: 'dagre',
  rankdir: 'TB',
  align: 'UL',
  nodesep: 50,
  ranksep: 100,
  controlPoints: true  // 允许处理没有边的节点
},
fitView: true,
fitViewPadding: 20
```

### 修复3：添加类型定义

在 `types/index.ts` 中为 `G6NodeData` 添加了 `x` 和 `y` 属性。

## 🚀 如何测试修复

### 步骤1：重新启动前端

```bash
# 停止当前运行的前端（Ctrl+C）
# 重新启动
cd Frontend
npm run dev
```

### 步骤2：刷新浏览器

在浏览器中按 `Ctrl+F5` 强制刷新页面，清除缓存。

### 步骤3：验证显示

1. 选择您的家族（公孙）
2. 查看中间的图形区域
3. 应该能看到两个节点：米强 和 米强2

## 🔧 如果问题仍然存在

### 检查1：查看浏览器控制台

按 `F12` 打开开发者工具，查看 Console 标签页：

- **是否有红色错误信息？**
  - 如果有 G6 相关错误，可能是库版本问题
  - 如果有 API 错误，检查后端是否正常运行

- **是否有网络请求失败？**
  - 查看 Network 标签页
  - 确认 `/api/families/{id}/members` 请求返回了数据

### 检查2：验证数据加载

在浏览器控制台输入：

```javascript
// 查看当前成员数据
console.log(window.$vm?.$data)
```

或者在 Vue DevTools 中查看 `familyStore.members` 是否有数据。

### 检查3：验证图形容器

在浏览器控制台输入：

```javascript
// 查看图形容器尺寸
const container = document.querySelector('.graph-container')
console.log('容器宽度:', container.offsetWidth)
console.log('容器高度:', container.offsetHeight)
```

如果高度为0，说明容器样式有问题。

### 检查4：手动触发渲染

在左侧成员列表中点击任意成员，看是否能触发图形更新。

## 🎨 建议的使用方式

为了更好地显示关系图，建议：

### 1. 创建有层次的家族结构

```
第1代：创建祖父/祖母
第2代：创建父亲/母亲，设置父母ID指向第1代
第3代：创建子女，设置父母ID指向第2代
```

### 2. 设置父子关系

在添加成员时：
- **父亲ID**：选择父亲
- **母亲ID**：选择母亲
- **世代**：正确设置世代数

### 3. 使用编辑功能

- 双击节点可以快速编辑
- 拖拽节点可以调整位置
- 点击"保存布局"保存位置

## 📝 临时解决方案

如果修复后仍有问题，可以尝试：

### 方案1：删除重建

1. 删除现有的两个成员
2. 重新创建，这次设置父子关系
3. 第一个成员：世代=1，不设置父母
4. 第二个成员：世代=2，设置父亲ID为第一个成员

### 方案2：清除浏览器缓存

```
Chrome: Ctrl+Shift+Delete
选择"缓存的图片和文件"
清除
```

### 方案3：使用无痕模式

在浏览器中打开无痕窗口，访问 http://localhost:5173

## 🐛 调试模式

如果需要更详细的调试信息，可以在 `FamilyTree.vue` 的 `renderGraph` 方法中添加日志：

```typescript
const renderGraph = () => {
  if (!graph) return

  const data = buildGraphData()
  
  // 添加调试日志
  console.log('渲染图形数据:', data)
  console.log('节点数量:', data.nodes.length)
  console.log('边数量:', data.edges.length)
  
  graph.data(data)
  graph.render()
  
  nextTick(() => {
    graph?.fitView(20)
  })
}
```

## 📞 联系支持

如果以上方法都无法解决问题，请提供：

1. 浏览器控制台的完整错误信息（截图）
2. Network 标签页中 API 请求的响应数据
3. 创建成员时填写的具体信息

---

**修复已完成**，请重启前端并刷新浏览器测试！
